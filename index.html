<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Logtime 42</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; margin: 0; padding: 2rem; background:#222; color:#eee; }
    .dark { background:#222; color:#eee; } .light { background:#f4f4f4; color:#111; }
    h2 { text-align:center; font-family: Orbitron, sans-serif; letter-spacing: .5px; }
    .toggle-theme { position:fixed; top:14px; right:16px; cursor:pointer; user-select:none; }
    .panel { max-width:900px; margin: 1rem auto; padding:1rem; border-radius:12px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); }
    .progress-container { width:100%; background:#444; border-radius:10px; overflow:hidden; height:22px; margin:.5rem 0; }
    .progress-bar { height:100%; background:linear-gradient(90deg,#4ade80,#22c55e); color:#000; font-weight:700; text-align:center; line-height:22px; }
    .calendar-title-container { text-align:center; margin:1rem 0 .5rem }
    .calendar-title { margin:0 }
    .calendar-container { max-width:900px; margin: 0 auto; }
    .calendar-grid { display:grid; grid-template-columns: repeat(8, 1fr); gap:6px; }
    .calendar-legend { display:grid; grid-template-columns:repeat(8,1fr); gap:6px; margin-top:.5rem; opacity:.8; font-size:.9rem; }
    .calendar-day { padding:.5rem; border-radius:10px; background:#333; min-height:54px; text-align:center; display:flex; flex-direction:column; justify-content:center; }
    .calendar-day.today { outline:2px solid #60a5fa; background:#1f2937; }
    .calendar-day.empty { background:transparent; border:1px dashed #444; }
    .calendar-day.total { background:#1f3d2b; border:1px solid #2e7d32; }
    .error { color:#fca5a5; }
    .muted { opacity:.8; font-size:.95rem; }
    .row { display:flex; gap:1rem; flex-wrap:wrap; }
    .chip { background:#444; padding:.25rem .5rem; border-radius:999px; }
    button { background:#4b9465; color:#fff; border:none; padding:.6rem .9rem; border-radius:8px; cursor:pointer; }
    button:hover { filter:brightness(1.05); }
  </style>
</head>
<body class="dark">
  <div class="toggle-theme" onclick="toggleTheme()">üåô</div>
  <h2>üîé Logtime 42 üîé</h2>

  <div class="panel" style="text-align:center">
    <button onclick="toggleView()" style="margin-bottom: .5rem;">üéõÔ∏è Basculer R√©sum√© / Calendrier</button>
    <div id="results" class="muted">‚è≥ Chargement‚Ä¶</div>
  </div>

  <div id="calendar" class="panel" style="padding-bottom:2rem; display:none;"></div>

  <script>
    // ========= CONFIG =========
    // Ton lien "pubhtml" converti en CSV
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPQeAGAWJrpnDLjyB2Xzl3qvJPYkK805vbWX-8vXJprO06mvwdXVKOa2jsvGwDkL0IxXvO4YTy4r5F/pub?gid=0&single=true&output=csv";

    // Weekly goal (peut rester fixe ou √™tre calcul√©, ici fixe pour rester fid√®le √† ton site)
    const WEEKLY_GOAL_HOURS  = 35;

    // ========= THEME =========
    function toggleTheme() {
      const body = document.body;
      body.classList.toggle('dark');
      body.classList.toggle('light');
      const isDark = body.classList.contains('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      document.querySelector('.toggle-theme').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    }
    (function () {
      const saved = localStorage.getItem('theme');
      if (saved === 'light') {
        document.body.classList.remove('dark');
        document.body.classList.add('light');
        document.querySelector('.toggle-theme').textContent = '‚òÄÔ∏è';
      }
    })();

    // ========= HELPERS =========
    const pad = n => String(n).padStart(2, '0');
    const minutesToStr = (m) => `${pad(Math.floor(m/60))}:${pad(m%60)}`;
    const strToMinutes = (hhmm) => {
      if (!hhmm || !/^\d{1,2}:\d{2}$/.test(hhmm.trim())) return 0;
      const [h,m] = hhmm.trim().split(":").map(Number);
      return (h*60 + m) | 0;
    };
    const parseFRDate = (s) => {
      const [d,m,y] = s.split("/").map(Number);
      return new Date(y, m-1, d);
    };
    const sameYMD = (a,b) => a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();

    function getWeekBounds(date) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const day = (d.getDay() + 6) % 7; // 0=lundi
      const monday = new Date(d); monday.setDate(d.getDate() - day);
      const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
      return { monday, sunday };
    }

    // ========= CSV FETCH & PARSE =========
    async function fetchCSV(url) {
      const sep = url.includes("?") ? "&" : "?";
      const res = await fetch(url + sep + "cb=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    }


    // Lecture robuste de F3 (ligne 3, colonne 6) depuis le CSV complet
    function extractMonthlyGoalFromCSV(csvText) {
    const rows = csvText.split(/\r?\n/).map(l => l.split(","));

    // 1) Essaie de trouver la colonne qui contient "Goal Hours" (dans les 6 premi√®res lignes)
    let col = -1, headerRow = -1;
    for (let r = 0; r < Math.min(6, rows.length); r++) {
      for (let c = 0; c < rows[r].length; c++) {
        const v = (rows[r][c] || "").toLowerCase();
        if (v.includes("goal hours")) { col = c; headerRow = r; break; }
      }
      if (col !== -1) break;
    }

    // 2) Si trouv√©e, lis la premi√®re valeur num√©rique sous/pr√®s de ce header
    if (col !== -1) {
      for (let r = headerRow; r <= headerRow + 4 && r < rows.length; r++) {
        const raw = (rows[r][col] || "").replace(/[^\d.,-]/g, "").replace(",", ".");
        const num = parseFloat(raw);
        if (Number.isFinite(num) && num > 0) return Math.round(num);
      }
    }

    // 3) Fallback direct sur F3 (ligne 3, col F = index [2][5])
    const rawF3 = (((rows[2] || [])[4]) || "").replace(/[^\d.,-]/g, "").replace(",", ".");
    const numF3 = parseFloat(rawF3);
    if (Number.isFinite(numF3) && numF3 > 0) return Math.round(numF3);

    // 4) Dernier secours
    return 140;
  }


    function parseCSVRowsForLogtime(csvText) {
      const lines = csvText.trim().split(/\r?\n/);

      // d√©tecte une √©ventuelle ligne d'ent√™tes "DATE,Logtime"
      let startIdx = 0;
      if (lines[0].toLowerCase().includes("date") && lines[0].toLowerCase().includes("logtime")) {
        startIdx = 1;
      }
      const rows = [];
      for (let i = startIdx; i < lines.length; i++) {
        const cols = lines[i].split(",");
        const date = (cols[0] || "").trim();
        const log  = (cols[1] || "").trim();
        if (!date) continue;
        rows.push({ date, log });
      }
      return rows;
    }

    function aggregate(rows) {
      const map = new Map();
      rows.forEach(r => {
        const mins = strToMinutes(r.log);
        if (mins > 0) map.set(r.date, mins);
      });

      const now = new Date();
      const { monday, sunday } = getWeekBounds(now);

      let todayMin = 0, weekMin = 0, monthMin = 0;
      const cal = {};

      map.forEach((mins, k) => {
        const d = parseFRDate(k);
        if (isNaN(d)) return;

        if (sameYMD(d, now)) todayMin += mins;
        if (d >= monday && d <= sunday) weekMin += mins;
        if (d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth()) {
          monthMin += mins;
          cal[d.getDate()] = `${Math.floor(mins/60)}h${pad(mins%60)}min`;
        }
      });

      return { todayMin, weekMin, monthMin, calendar: cal };
    }

    function generateCalendar(calendarData) {
      const calendarDiv = document.getElementById("calendar");
      calendarDiv.className = "calendar-container";
      calendarDiv.innerHTML = `
        <div class="calendar-title-container">
          <h4 class="calendar-title">üìÖ Logtime journalier du mois</h4>
        </div>
      `;

      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const today = now.getDate();

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const totalDays = lastDay.getDate();

      let html = '<div class="calendar-grid">';
      let weekTotal = 0;
      let dow = firstDay.getDay(); // 0=dimanche..6=samedi
      if (dow === 0) dow = 7; // Lundi=1

      for (let i = 1; i < dow; i++) html += `<div class="calendar-day empty"></div>`;
      let colCount = dow - 1;

      for (let day = 1; day <= totalDays; day++) {
        const log = calendarData[day] || "";
        const isToday = day === today;
        const display = log ? log : "-";
        const mins = log
          ? (parseInt(log.split("h")[0]||0)*60 + parseInt((log.split("h")[1]||"").replace("min","")||0))
          : 0;

        weekTotal += mins;
        colCount++;

        html += `<div class="calendar-day${isToday ? ' today' : ''}">
          <strong>${day}</strong><br>${display}
        </div>`;

        if (colCount === 7 || day === totalDays) {
          if (colCount < 7) {
            for (let j = colCount; j < 7; j++) html += `<div class="calendar-day empty"></div>`;
          }
          const h = Math.floor(weekTotal / 60), m = weekTotal % 60;
          html += `<div class="calendar-day total week-total">üßÆ <strong>${h}h ${pad(m)}min</strong></div>`;
          colCount = 0;
          weekTotal = 0;
        }
      }
      html += "</div>";
      html += `
        <div class="calendar-legend">
          <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div>
          <div>Ven</div><div>Sam</div><div>Dim</div><div>Total</div>
        </div>
      `;
      calendarDiv.innerHTML += html;
    }

    function renderSummary({ todayMin, weekMin, monthMin, calendar }, monthlyGoalHours) {
      const results = document.getElementById("results");

      const monthlyGoalSeconds = monthlyGoalHours * 3600;
      const percent = Math.min(100, Math.round((monthMin*60) / monthlyGoalSeconds * 100));

      const remainingWeekMin  = Math.max(0, WEEKLY_GOAL_HOURS*60 - weekMin);
      const remainingMonthMin = Math.max(0, monthlyGoalHours*60 - monthMin);

      results.innerHTML = `
        <h3>üìä R√©sum√©</h3>
        <div class="row">
          <span class="chip">üìÖ Aujourd'hui : <strong>${minutesToStr(todayMin)}</strong></span>
          <span class="chip">üìÜ Cette semaine : <strong>${minutesToStr(weekMin)}</strong> &nbsp; <small>‚è≥ Reste : ${minutesToStr(remainingWeekMin)} | üéØ ${WEEKLY_GOAL_HOURS}h</small></span>
          <span class="chip">üóìÔ∏è Ce mois : <strong>${minutesToStr(monthMin)}</strong> &nbsp; <small>‚è≥ Reste : ${minutesToStr(remainingMonthMin)}</small></span>
        </div>

        <div class="progress-container" title="Objectif mensuel ${monthlyGoalHours}h">
          <div class="progress-bar" style="width:${percent}%;">${percent}%</div>
        </div>
        <p class="muted">üéØ Objectif mensuel : <strong>${monthlyGoalHours}h</strong> (lu depuis E3 du Google Sheet)</p>
      `;

      generateCalendar(calendar);
    }

    async function loadAndRender() {
      const results = document.getElementById("results");
      try {
        results.textContent = "‚è≥ Chargement‚Ä¶";
        const csv = await fetchCSV(SHEET_CSV_URL);

        // 1) Objectif mensuel depuis F3
        const monthlyGoalFromSheet = extractMonthlyGoalFromCSV(csv);
        const MONTHLY_GOAL_HOURS = Number.isFinite(monthlyGoalFromSheet) ? monthlyGoalFromSheet : 140;

        // 2) Lignes A/B pour les calculs
        const rows = parseCSVRowsForLogtime(csv);
        const agg  = aggregate(rows);

        renderSummary(agg, MONTHLY_GOAL_HOURS);
      } catch (e) {
        results.innerHTML = `<span class="error">‚ùå Erreur de chargement : ${e.message}</span>`;
      }
    }

    function toggleView() {
      const results = document.getElementById("results");
      const calendar = document.getElementById("calendar");
      const showCal = results.style.display !== "none";
      results.style.display = showCal ? "none" : "block";
      calendar.style.display = showCal ? "block" : "none";
    }

    window.onload = loadAndRender;
  </script>
</body>
</html>
