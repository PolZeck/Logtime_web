<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logtime 42</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="dark">
  <div class="toggle-theme" onclick="toggleTheme()">🌙</div>
  <h2>🔎 Logtime 42 🔎</h2>
  <div class="favorites">
	<strong>⭐ Favoris :</strong><br>
	<select onchange="selectLogin(this.value)">
	  <option value="">-- Choisir un favori --</option>
	  <option value="pledieu">pledieu</option>
	  <option value="lcosson">lcosson</option>
	  <option value="abouclie">abouclie</option>
	</select>
	<br><br>
	<strong>🤟 Inutiles❗ :</strong><br>
	<select onchange="selectLogin(this.value)">
	  <option value="">-- Choisir un inutile --</option>
	  <option value="yalaatik">yalaatik</option>
	  <option value="vdurand">vdurand</option>
	  <option value="arocca">arocca</option>
	</select>
  </div>
  
  <div style="text-align:center;">
    <input type="text" id="login" placeholder="ex: pledieu">
    <button onclick="fetchLogtime()">Afficher</button>
  </div>
  <div id="results"></div>
  <div id="calendar" style="margin-bottom: 2rem;"></div>

</div>
  <script>
    function toggleTheme() {
      const body = document.body;
      body.classList.toggle('dark');
      body.classList.toggle('light');
      const isDark = body.classList.contains('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      document.querySelector('.toggle-theme').textContent = isDark ? '🌙' : '☀️';
    }

    (function () {
      const saved = localStorage.getItem('theme');
      if (saved === 'light') {
        document.body.classList.remove('dark');
        document.body.classList.add('light');
        document.querySelector('.toggle-theme').textContent = '☀️';
      }
    })();

    function selectLogin(login) {
      document.getElementById("login").value = login;
      fetchLogtime();
    }

	function generateCalendar(calendarData) {
  const calendarDiv = document.getElementById("calendar");
  calendarDiv.className = "calendar-container";
  calendarDiv.innerHTML = `
  <div class="calendar-title-container">
    <h4 class="calendar-title">📅 Logtime journalier du mois</h4>
  </div>
`;

  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = now.getDate();

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const totalDays = lastDay.getDate();

  let html = '<div class="calendar-grid">';
  let weekTotal = 0;
  let dayOfWeek = firstDay.getDay(); // 0 (dimanche) à 6 (samedi)
  if (dayOfWeek === 0) dayOfWeek = 7; // on fait commencer lundi = 1

  // 🕳 Cases vides avant le premier jour (lundi = 1)
  for (let i = 1; i < dayOfWeek; i++) {
    html += `<div class="calendar-day empty"></div>`;
  }

  let colCount = dayOfWeek - 1;

  for (let day = 1; day <= totalDays; day++) {
    const log = calendarData[day] || "";
    const isToday = day === today;
    const display = log ? log : "-";
    const minutes = parseInt(log?.split("h")[0] || 0) * 60 + parseInt(log?.split("h")[1]?.replace("min", "") || 0);

    weekTotal += minutes;
    colCount++;

    html += `<div class="calendar-day${isToday ? ' today' : ''}">
      <strong>${day}</strong><br>${display}
    </div>`;

    // ⏹ Fin de semaine ou fin du mois
    if (colCount === 7 || day === totalDays) {
      if (colCount < 7) {
        for (let j = colCount; j < 7; j++) {
          html += `<div class="calendar-day empty"></div>`;
        }
      }

      const hours = Math.floor(weekTotal / 60);
      const mins = weekTotal % 60;

      html += `<div class="calendar-day total week-total">
        🧮 <strong>${hours}h ${mins}min</strong>
      </div>`;

      colCount = 0;
      weekTotal = 0;
    }
  }

  html += "</div>";
  html += `
    <div class="calendar-legend">
      <div>Lun</div>
      <div>Mar</div>
      <div>Mer</div>
      <div>Jeu</div>
      <div>Ven</div>
      <div>Sam</div>
      <div>Dim</div>
      <div>Total</div>
    </div>
  `;
  calendarDiv.innerHTML += html;

}



    async function fetchLogtime() {
      const login = document.getElementById("login").value;
      const results = document.getElementById("results");
      results.innerHTML = "⏳ Chargement...";

      try {
        const res = await fetch(`https://logtime-web.onrender.com/logtime?login=${login}`);
        const data = await res.json();

        if (data.error) {
          results.innerHTML = "❌ Erreur : " + data.error;
		} else {
			const monthlyGoalSeconds = data.monthly_goal_hours * 3600.0;
			const percent = Math.min(100, Math.round((data.month_raw / monthlyGoalSeconds) * 100));
			const weeklyGoal = data.weekly_goal_hours;

			results.innerHTML = `
				<h3>📊 Résultat pour <strong>${login}</strong></h3>
				<p>📅 Aujourd'hui : ${data.today}</p>
				<p>📆 Cette semaine : ${data.week} <br><small>⏳ Reste : ${data.remaining_week} | 🎯 Objectif : ${weeklyGoal}h</small></p>
				<p>🗓️ Ce mois : ${data.month} <br><small>⏳ Reste : ${data.remaining_month}</small></p>

				<div class="progress-container">
				<div class="progress-bar" style="width:${percent}%;">${percent}%</div>
				</div>
				<p>🎯 Objectif mensuel : ${data.monthly_goal_hours}h</p>
			`;
			generateCalendar(data.calendar);
		}
      } catch (e) {
        results.innerHTML = "❌ Erreur de requête : " + e;
      }
    }
  </script>
</body>
</html>